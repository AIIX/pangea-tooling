env.DIST = '<%= dist %>'
env.TYPE = '<%= type %>'
env.APTLY_REPOSITORY = '<%= repo %>'
env.PWD_BIND = '/workspace'
env.PANGEA_DOCKER_IMAGE = 'debian:sid'

node('cloud && amd64') {
    wrap([$class: 'TimestamperBuildWrapper']) {
        wrap([$class: 'AnsiColorBuildWrapper', colorMapName: 'xterm']) {
            stage('clone[tooling]') {
                sh '[ -d tooling ] || mkdir tooling'
                dir('tooling') {
                    git branch: 'master', url: 'https://github.com/blue-systems/pangea-tooling'
                }
            }

            stage('generate') {
                sh 'tooling/nci/contain.rb $PWD_BIND/tooling/nci/asgen.sh'
            }

            stage('publish') {
                withCredentials([sshUserPrivateKey(credentialsId: 'ssh.jobs.archive.neon', keyFileVariable: 'SSH_KEY_FILE', passphraseVariable: '', usernameVariable: '')]) {
                    sh '~/tooling/nci/asgen_push.rb'
                }
            }
        }
    }
}
